<!DOCTYPE html>
<html>
  <head>
    <title>RNA Dotplots, McCaskill and Locality</title>
    <meta charset="utf-8">
    <style>
       @import url(https://fonts.googleapis.com/css?family=Droid+Serif);
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
        font-family: 'Droid Serif';
      }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: 400;
        margin-bottom: 0;
      }
      .remark-slide-content h1 { font-size: 3em; }
      .remark-slide-content h2 { font-size: 2em; }
      .remark-slide-content h3 { font-size: 1.6em; }
      .footnote {
        position: absolute;
        bottom: 3em;
      }
      li p { line-height: 1.25em; }
      .red { color: #fa0000; }
      .gray { color: #777; }
      .large { font-size: 2em; }
      .small { font-size: 0.5em; }
      a, a > code {
        color: rgb(249, 38, 114);
        text-decoration: none;
      }
      code {
        background: #e7e8e2;
        border-radius: 5px;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .remark-code-line-highlighted     { background-color: #373832; }
      .pull-left {
        float: left;
        width: 47%;
      }
      .pull-right {
        float: right;
        width: 47%;
      }
      .pull-right ~ p {
        clear: both;
      }
      #slideshow .slide .content code {
        font-size: 0.8em;
      }
      #slideshow .slide .content pre code {
        font-size: 0.9em;
        padding: 15px;
      }
      .inverse {
        background: #272822;
        color: #777872;
        text-shadow: 0 0 20px #333;
      }
      .inverse h1, .inverse h2 {
        color: #f3f3f3;
        line-height: 0.8em;
      }

      /* Slide-specific styling */
      #slide-inverse .footnote {
        bottom: 12px;
        left: 20px;
      }
      #slide-how .slides {
        font-size: 0.9em;
        position: absolute;
        top:  151px;
        right: 140px;
      }
      #slide-how .slides h3 {
        margin-top: 0.2em;
      }
      #slide-how .slides .first, #slide-how .slides .second {
        padding: 1px 20px;
        height: 90px;
        width: 120px;
        -moz-box-shadow: 0 0 10px #777;
        -webkit-box-shadow: 0 0 10px #777;
        box-shadow: 0 0 10px #777;
      }
      #slide-how .slides .first {
        background: #fff;
        position: absolute;
        top: 20%;
        left: 20%;
        z-index: 1;
      }
      #slide-how .slides .second {
        position: relative;
        background: #fff;
        z-index: 0;
      }

      /* Two-column layout */
      .left-column {
        color: #777;
        width: 20%;
        height: 92%;
        float: left;
      }
        .left-column h2:last-of-type, .left-column h3:last-child {
          color: #000;
        }
      .right-column {
        width: 75%;
        float: right;
        padding-top: 1em;
      }

           /* Two-column layout */
      .my-left-column {

        width: 70%;
        float: left;
      }
       
      .my-right-column {
        color: #888;
        width: 15%;
        float: right;
        height: 92%;

        padding-top: 1em;
      }
       .my-right-column h2:last-of-type, .my-right-column h3:last-child {
          color: #001;
        }
    </style>
  </head>
  <body>
    <textarea id="source">
name: inverse
layout: true
class: center, middle, inverse
--- 

---
layout: false

.center[

## RNA Nearest Neighbor Energy Model 
###  and 
## The Curse of Locality
# 
# 
# 
#### Milad Miladi
#### Herzogenhorn, April 2016 
]

---

### .center[Probability of an structure in the ensemble]
.center[![](prob-vis.svg)]
- BW:
     - Boltzmann Weight
     - Exponential function  => exponential scale behaviors!

- Z:  
     - Partition function
     - Sum of the Boltzmann weights for the entire ensemble

---

layout: false
.my-left-column[.center[##McCaskill, 1990, ]

  - For a given sequence, efficient methods for: 
  1. **partition function (Z)**  
    - Z(i,j) 
    - For all sub-sequences
        
  2. **probability of an individual base-pair** in ensemble 
      - p(i,j)   
      - For all possible pairs

  3. Visualizing all base-pair probabilities as **dot plot**
      - Area(i,j) = p(i,j) . Unit-Area
  
]
.my-right-column[
<img align="top" src="john_s_maccaskill_young.jpeg"  width="70" > 

 Z(1,72)=-25.45 kcal/mol

##### p(3,68)=0.9

![](X70810.2.svg)
]

<!-- ---

layout: false
.my-left-column[.center[##McCaskill, 1990, ]
###Based on Turner energy model
###No heuristics and approximation in the computations!
]
.my-right-column[
<img align="top" src="john_s_maccaskill_young.jpeg"  width="70" > 

 Z(1,72)=-25.45 kcal/mol

##### p(3,68)=0.9

![](X70810.2.svg)
]
 -->

---
  
* # Part 1: The problem

---
### .center[Target example]
- A classic tRNA!

![](X70810.2_centroid.svg)
![](X70810.2_heatmap.svg)

---
### .center[Test 1: Extension]
  
  - Di-Nucleotide shuffled genomic context
  - tRNA position:
     - close to the center of the extension
     - according to a normal distribution
  - Target: a base-pair from *the acceptor stem*
.center[![](X70810.2_extend.svg)]


---
### .center[Probability of the selected base-pair (by global folding)]

- Context-length: 
    - Total length of the left and right extensions 
- Each time the context is re-shuffled and re-sampled

![](tRNA-Turner-extend.svg) ![](X70810.2_extend_small.svg)

---
### .center[Test 2: Split]
.center[![](X70810.2_split.svg)]
 <!-- ![](X70810.2_stem_split.svg) -->
---
### .center[Probability of the selected base-pair (by global folding)]
- Each time the context is re-shuffled and re-sampled
![](tRNA-split.svg) ![](X70810.2_split_small.svg)

<!-- ![](stem-split.svg) ![](X70810.2_stem_split_small.svg) -->

---
### .center[Problems]
* **Locality** problem: *(extend test)*
    - Desired base-pair probabilities easily distorted 
    - Specially for the closing stems of multi-loops
.right[![](X70810.2_extend_small.svg)]

* **Anti-locality** problem(?): *(split)*
    - No matter how long a sequence is ..
    
    - No matter what is inside ..
    
    - Few distant compatible base-pairs make an strong prediction!
.right[![](X70810.2_stem_split_small.svg)]

---
.center[Split example]
![](sample_trna2_nonsymmetric_dp_turner.ps.svg)

---
.center[Split example]
![](sample_trna2_nonsymmetric_dp_turner.ps_inverse.svg)

---
### .center[(Slide from my talk last month)]
### .center[What is missing?]
Turner?
* Turner energy model should not be that much mad

McCaskill?
* McCaskill algorithm has no heuristics or simplification..

---
   
  
* #### Part 1: The problem
* # Part 2:  mmfold

---
### .center[ Base pairing probability computation ]

### Irreversibility hypothesis:

  1. Markov chain of base-pair probabilities is not reversible
  
  2. Computing the Markov chain with McCaskill's *outside* algorithm causes the locality problem (to some extend)

![](outside.svg)  ![](inside.svg)

---
layout: false
### .center[mmfold inside algorithm]

- Calculating the base-pair probabilities with an inside algorithm

    1. Base case: P_Hairpin(a) 
    2. Inner Loop: P(a| a is closing b )
    3. Multiloop: P(a| a is closing multiloop b1, b2, ... )


 ![](basecase.svg)
 ![](innerloop.svg)
 ![](multiloop.svg)

---
### .center[mmfold implementation]
- Implemented in C with fun and pain! :D
- Directly inside cloned Vienna RNA package

```cpp
PUBLIC void mm_pf_create_bppm( vrna_fold_compound_t *vc, char *structure){
    ...
    probs[ij] = mc_probs[ij]/
                qb[ij] *  
                exp_E_Hairpin(j-i-1, type, S1[i+1], S1[j-1], 
                    sequence+i-1 ,pf_params) * scale[j-i+1]; 
                    // TODO: Verify rescaling is correct!
    ...
    FLT_OR_DBL 
    new_score = probs[ij] * (mc_probs[kl]/mc_probs[ij])
                * (qb[ij]/qb[kl]) * (scale[u1 + u2 + 2]
                * exp_E_IntLoop(u1, u2, type, type_2_r, S1[k+1], S1[l-1], 
                *               S1[i-1], S1[j+1],  pf_params));
                
    ...

    tmp = qq1;  qq1 =qq;  qq =tmp;
    tmp = qqm1; qqm1=qqm; qqm=tmp;

}
```
- In my spare time (4 weekends + couple of afternoons)
- With a bunch of TODOS!

---
.center[mmfold alpha: output]
```bash
$ mmfold -p -P src/misc/rna_turner2004.par < trna2.fa 
```
![](sample_trna2_nonsymmetric_mm_dp.filt.ps.svg)
---
.center[mmfold alpha: output]

```bash
$ mmfold -p -P src/misc/rna_turner2004.par < trna2.fa 
```

![](sample_trna2_nonsymmetric_mm_dp.filt.ps_inverse.svg)

---
### .center[mmfold outcome]
- My irreversibility hypothesis failed 
<img align="top" src="thumbsdown.png"  width="30" > 

- Rolf and Martin were right ;-)

- But I also deep learned "Nearest Neighbor Energy Model"!


```cpp
FLT_OR_DBL branch_energy = E_MLstem(type, S1[h-1], S1[k+1], vc->params);

FLT_OR_DBL branch_pf = exp_E_MLstem(rtype[type], S1[h-1], S1[k+1], pf_params);

FLT_OR_DBL qb_energy = (-log(qb[kh]) -(h-k+1)*log(pf_params->pf_scale))
                        *pf_params->kT/10.;
```

---
--- 
* #### Part 1: The problem
* #### Part 2:  mmfold
* # Part 3: Quake


---
.center[Quake example]
![](sample_trna2_nonsymmetric_dp_quake.ps.svg)

---
.center[Quake example]
![](sample_trna2_nonsymmetric_dp_quake.ps_inverse.svg)

---
#### .center[Extend: Turner vs Quake]
![](tRNA-Turner-extend.svg) ![](X70810.2_extend_small.svg)
![](tRNA-Quake-extend.svg) 

---
#### .center[Extend: Turner vs Quake (Log scale)]
![](tRNA-Log-Turner-extend.svg) ![](X70810.2_extend_small.svg)
![](tRNA-Log-Quake-extend.svg)

---
### .center[What is Quake?]
- RNAfold uses the famous Turner's energy parameters for free energy computations

- It is a new parameter set

```bash
RNAfold -p -P src/misc/quake.par
```

---
### .center[What is Quake?]
- RNAfold uses the famous Turner's energy parameters for free energy computations

- It is a new parameter set

```bash
RNAfold -p -P src/misc/quake.par
```

- Not really!
 
- It is Turner's params except one param:
  
  - Unpaired nucleotide penalty of a multiloop region 

---
### .center[Turner vs Quake]
- Turner:

<img align="top" src="turner-params.png"  width="750" > 

- Quake:
```bash
/* F = cu*n_unpaired + cc + ci*loop_degree (+TermAU) */
/*   cu      cu_dH   cc    cc_dH      ci     ci_dH  */
         50      0       930    3000     -190    -220 
```
---
--- 
* #### Part 1: The problem
* #### Part 2:  mmfold
* #### Part 3: Quake
* ## Part 4: Quake Evaluation

---
#### .center[Localfold CisReg  dataset, Context 0]
.center[Basepair accuracy (=expected sensitivity)]
![](boxplots-cont0-bp-accuracy-constraint-all.svg.svg)
---
#### .center[Localfold CisReg  dataset, Context 200]
.center[Basepair accuracy (=expected sensitivity)]
![](boxplots-cont200-bp-accuracy-constraint-all.svg.svg)

<!-- ---
#### .center[Localfold CisReg  dataset]
.left[Basepair accuracy (=expected sensitivity)]
![](boxplots-cisreg-bp-accuracy-constraint-RF00023.svg.svg)
 -->
---
#### .center[Localfold CisReg  dataset]
.center[Basepair accuracy (=expected sensitivity)]
![](boxplots-cisreg-bp-accuracy-constraint-RF00036.svg.svg)
---
#### .center[Localfold CisReg  dataset]
.center[Basepair accuracy (=expected sensitivity)]
![](boxplots-cisreg-bp-accuracy-constraint-RF00041.svg.svg)
---
#### .center[Localfold CisReg  dataset]
.center[Basepair accuracy (=expected sensitivity)]
![](boxplots-cisreg-bp-accuracy-constraint-RF00048.svg.svg)
---
#### .center[Localfold CisReg  dataset]
.center[Basepair accuracy (=expected sensitivity)]
![](boxplots-cisreg-bp-accuracy-constraint-RF00386.svg.svg)
---
#### .center[Localfold CisReg  dataset]
.center[Basepair accuracy (=expected sensitivity)]
![](boxplots-cisreg-bp-accuracy-constraint-RF00515.svg.svg)

<!-- ---
#### .center[Localfold CisReg  dataset]
.center[Basepair accuracy (=expected sensitivity)]
![](boxplots-cisreg-bp-accuracy-constraint-RF01418.svg.svg)
 -->
---

---
layout: false

.center[

### .gray[RNA Dotplots, ]
### .gray[McCaskill ]
## and the curse of Locality
]


    </textarea>
    <script src="https://gnab.github.io/remark/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>